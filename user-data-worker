#cloud-config

apt_update: true
apt_upgrade: true
apt_reboot_if_required: true

apt_sources:

# Docker
- source: "deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable"
  filename: "docker.list"
  keyid: "0EBFCD88"

# Kubeadm
- source: "deb http://apt.kubernetes.io/ kubernetes-xenial main"
  filename: "kubernetes.list"

packages:
- docker-ce
- kubelet
- kubeadm
- kubectl
- sudo
- ssh-import-id
- sysstat

manage_etc_hosts: localhost

ssh_authorized_keys:
- ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key

bootcmd:
- "ln -snf /run/resolvconf/resolv.conf /etc/resolv.conf"
- bash -c "curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -"

write_files:
- path: "/etc/hosts"
  permissions: "0644"
  owner: "root:root"
  content: |
    127.0.0.1 localhost
    10.100.1.101 m01
    10.100.1.111 w01
    10.100.1.112 w02
    10.100.1.113 w03

- path: "/provision.sh"
  permissions: "0744"
  owner: "root:root"
  content: |
    #!/bin/bash -eux
    kubeadm join \
      --token a36ef3.6f6960dfc28f769d \
      --discovery-token-unsafe-skip-ca-verification \
      10.100.1.101:6443

    # advertise correct IP address
    ADVERTISE_IP=$(ip -4 addr show enp0s8 | grep "inet" | head -1 |awk '{print $2}' | cut -d/ -f1)
    #sed -e "s/KUBELET_NETWORK_ARGS=/KUBELET_NETWORK_ARGS=--hostname-override=${HOSTNAME}.${ADVERTISE_IP}.nip.io /" \
    #  -i /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    #systemctl daemon-reload
    #systemctl restart kubelet

- path: "/etc/sysctl.d/99-kubernetes.conf"
  permissions: "0644"
  owner: "root:root"
  content: |
    # Flannel
    net.bridge.bridge-nf-call-iptables = 1

runcmd:
- sysctl net.bridge.bridge-nf-call-iptables=1
- /provision.sh
