#cloud-config
# https://scottlinux.com/2014/12/08/how-to-create-a-systemd-service-in-linux-centos-7/

apt_update: true
apt_upgrade: true

manage_etc_hosts: localhost

ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key

bootcmd:
  - "ln -snf /run/resolvconf/resolv.conf /etc/resolv.conf"

packages:
- iperf3

write_files:
- path: "/etc/systemd/system/iperf3.service"
  mode: "0644"
  content: |
    [Unit]
    Description=iperf3 Service
    After=network.target

    [Service]
    Type=simple
    ExecStart=/usr/bin/iperf3 -s
    Restart=on-abort

    [Install]
    WantedBy=multi-user.target

runcmd:
- systemctl daemon-reload
- systemctl enable iperf3.service

# Reboot after this script is done in case system upgrade requires a reboot
power_state:
  mode: reboot
  message: "Rebooting.  Brb."
  timeout: 3600 # Just set it for 1h so the script has time to run
  condition: true
