#cloud-config

apt_update: true
apt_upgrade: true

manage_etc_hosts: localhost

ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key

bootcmd:
  - "ln -snf /run/resolvconf/resolv.conf /etc/resolv.conf"

runcmd:
  - apt-get autoremove -y
  - passwd --delete root
  - passwd --delete ubuntu
  - cd /playbooks
  - ansible-galaxy install --force --role-file=requirements.yml
  - sudo -u ubuntu -- ansible-playbook -vvv storage.yml
  - echo "FINITO"

apt_sources:

  # Ansible
  - source: "ppa:ansible/ansible"
    filename: "ansible.list"

packages:
  - ansible=2.2.1.0-1ppa~xenial
  - bash

write_files:
  - path: "/playbooks/requirements.yml"
    mode: "0644"
    content: |
      - src: "jacoelho.softwareraid"
        version: "v1.2.0"
      - src: "AerisCloud.disk"
        version: "v2.2.0"

  - path: "/playbooks/storage.yml"
    mode: "0644"
    content: |
      - name: "set up host storage"
        hosts: localhost
        become: yes
        roles:
          - role: "jacoelho.softwareraid"
            software_raid_devices:
              - device: "/dev/md0"
                level: 0
                components:
                  - "/dev/sdb"
                  - "/dev/sdc"
                  - "/dev/sdd"
                filesystem_type: "ext4"
                mount_point: "/data/persistent"
                mount_options: "rw,noatime"
                dump: 0
                passno: 0

# Reboot after this script is done in case system upgrade requires a reboot
power_state:
  mode: reboot
  message: "Rebooting.  Brb."
  timeout: 3600 # Just set it for 1h so the script has time to run
  condition: true
